<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca_Digital</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    /* --- estilos como antes --- */
    body {
      font-family: Arial, sans-serif;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    nav {
      width: 100%;
      background-color: #0e0955;
      color: white;
      padding: 15px 0;
      text-align: center;
      position: fixed;
      top: 0;
      left: 0;
      height: 7%;
      z-index: 1000;
    }
    .contenedor-cuadros {
      margin-top: 65px;
      margin-left: 2%;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      align-items: stretch;
      gap: 40px 5px;
    }
    #btn-añadir {
      background-color: #9fbaf5;
      width: 10%;
      border: 2px solid #000000;
      height: 68px;
      margin-left: 74%;
      font-size: 17px;
      margin-top: -68px;
    }
    .cuadro {
      width: 82%;
      height: 420px;
      background-color: #dddddd;
      margin-left: 10px;
      text-align: left;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .barra-busqueda {
      display: flex;
      padding-top: 4%;
      margin-left: -322px;
      justify-content: center;
    }
    #barraInput {
      width: 54%;
      padding: 12px 20px;
      border: 2px solid #000000;
      font-size: 16px;
      outline: none;
      height: 40px;
      margin-top: 80px;
    }
    .barra-busqueda button {
      display: none;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      height: 80%;
      width: 80%;
      margin-top: 80px;
      text-align: center;
    }
    .modal input {
      width: 35%;
      padding: 10px;
      margin: 10px 0;
    }
    .modal button {
      padding: 10px;
      width: 20%;
      margin-right: 60%;
    }
    .editar-btn {
      color: white;
      background-color: #800000;
      border: none;
      padding: 8px 16px;
      font-size: 18px;
      height: 40px;
      margin-top: auto;
      cursor: pointer;
      border-radius: 5px;
    }
    #btnEliminar {
      background-color: crimson;
      color: white;
      display: none;
    }
    .eliminar-btn {
      background-color: crimson;
      color: white;
      border: none;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 10px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 10px;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .ejemplares {
      width: 45%;
      height: 78%;
      margin-top: -277px;
      background-color: #c00f0f;
      margin-left: 54%;
    }
    #listaEjemplares {
      margin-top: -427px;
      width: 44%;
      height: 380px;
      margin-left: 588px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #aaa;
      padding: 10px;
      box-sizing: border-box;
    }

  </style>
</head>
<body>
  <nav></nav>

  <div class="barra-busqueda">
    <input type="text" id="barraInput" placeholder="Buscar..." />
    <button onclick="buscar()">Buscar</button>
  </div>

  <img src="imagenes/escudo_11.png" alt="escudo_11" style="width: 12%; height: 20%; margin-left: 80%; margin-top: -9%;" />

  <div style="display: flex; justify-content: flex-start; gap: 20px; margin: 20px 2% 0 2%; margin-right: 97%; margin-top: -90px;">
    <button id="btn-añadir" style="background-color:#9fbaf5; width: 180px; border: 2px solid #000000; height: 68px; font-size: 17px; margin-top: 0px;">
      Añadir libro
    </button>

    <button id="btn-backup" style="background-color: #e5c94a; width: 180px; border: 2px solid #000000; height: 68px; font-size: 17px;">
      Realizar Backup
    </button>

    <button id="btn-importar" style="background-color: #94e18c; width: 180px; border: 2px solid #000000; height: 68px; font-size: 17px;">
      Importar Backup
    </button>
    <input type="file" id="input-importar" accept=".json" style="display: none;" />

    <button id="btn-borrar-todo" style="background-color: #df0404; width: 180px; border: 2px solid #000000; height: 68px; font-size: 17px;">
      Eliminar inventario
    </button>
  </div>

  <div class="contenedor-cuadros"></div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitulo">Nuevo Libro</h3>

      <div class="form-grid">
        <input type="text" id="titulo" placeholder="Título del libro" />
        <input style="margin-left: -260px;" type="date" id="fechaIngreso" placeholder="Fecha de ingreso" />
        <input  type="text" id="autor" placeholder="Autor" />
        <input style="margin-left: -260px;" type="text" id="editorial" placeholder="Editorial" />
        <input  type="text" id="lugar" placeholder="Lugar de publicación" />
        <input style="margin-left: -260px;" type="number" id="paginas" placeholder="Cantidad de páginas" />
        <input type="number" id="anio" placeholder="Año de publicación" />
        <input style="margin-left: -260px;" type="text" id="inventarioBase" placeholder="Número de inventario inicial" />
        <input  type="number" id="cantidadEjemplares" placeholder="Cantidad de ejemplares" />
      </div>

      <div class="ejemplares"></div>

      <input type="file" id="imagenInput" accept="image/*" style="display: none;" />
      <img id="imagenPreview" style="max-width: 100px; margin-top: 10px;" />
      <button onclick="guardarLibro()" style="margin-top: -100px;">Guardar</button>
      <button id="btnEliminar" class="eliminar-btn" style="display:none;">Eliminar libro</button>

      <div id="listaEjemplares" style="padding: 5px; text-align: left;"></div>
    </div>
  </div>

  
  <script>
    const modal = document.getElementById('modal');
    const btnAñadir = document.getElementById('btn-añadir');
    const imagenInput = document.getElementById('imagenInput');
    const imagenPreview = document.getElementById('imagenPreview');
    const modalTitulo = document.getElementById('modalTitulo');
    const listaEjemplares = document.getElementById('listaEjemplares');

    let imagenData = '';
    let modoEdicion = false;
    let docsEjemplaresActuales = [];
    let tituloOriginal = '';

    btnAñadir.addEventListener('click', () => {
      limpiarModal();
      modoEdicion = false;
      modalTitulo.textContent = 'Nuevo libro';
      modal.style.display = 'block';
    });

    imagenInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imagenData = e.target.result;
          imagenPreview.src = imagenData;
          imagenPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    function generarRectangulosEjemplares() {
      const inventarioBase = parseInt(document.getElementById('inventarioBase').value);
      const cantidad = parseInt(document.getElementById('cantidadEjemplares').value);
      listaEjemplares.innerHTML = ''; // limpiar antes de generar

      if (isNaN(inventarioBase) || isNaN(cantidad)) return;

      for (let i = 0; i < cantidad; i++) {
        const ejemplar = document.createElement('div');
        ejemplar.className = 'ejemplar';
        ejemplar.style.border = '1px solid #555';
        ejemplar.style.margin = '5px 0';
        ejemplar.style.padding = '5px';

        const inventario = inventarioBase + i;
        ejemplar.textContent = `Ejemplar ${i + 1}: ${inventario}`;
        listaEjemplares.appendChild(ejemplar);
      }
    }

    // Inicializar Firebase (con tu config)
    const firebaseConfig = {
      apiKey: "AIzaSyB-xkjdruerF7AOthyu45T_bETa97x6_pg",
      authDomain: "farmacia-web-d0d71.firebaseapp.com",
      projectId: "farmacia-web-d0d71",
      storageBucket: "farmacia-web-d0d71.firebasestorage.app",
      messagingSenderId: "580153875699",
      appId: "1:580153875699:web:aa53b21ba70a5bc7396b86",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function guardarLibro() {
      const titulo = document.getElementById('titulo').value.trim();
      const autor = document.getElementById('autor').value.trim();
      const editorial = document.getElementById('editorial').value.trim();
      const lugar = document.getElementById('lugar').value.trim();
      const paginas = parseInt(document.getElementById('paginas').value);
      const anio = parseInt(document.getElementById('anio').value);
      const inventarioBase = parseInt(document.getElementById('inventarioBase').value);
      const cantidadEjemplares = parseInt(document.getElementById('cantidadEjemplares').value);
      const fechaIngreso = document.getElementById('fechaIngreso').value;


      if (
        !titulo || !autor || !editorial || !lugar ||
        isNaN(paginas) || isNaN(anio) || isNaN(inventarioBase) || isNaN(cantidadEjemplares)
      ) {
        alert('Por favor completá todos los campos correctamente.');
        return;
      }

      try {
        if (!modoEdicion) {
          // Añadir nuevos ejemplares con ID personalizado
          const promesas = [];
          for (let i = 0; i < cantidadEjemplares; i++) {
            const inventario = inventarioBase + i;
            const idPersonalizado = `${titulo.replace(/\s+/g, '_')}-${inventario}`;

            const ejemplar = {
              id: idPersonalizado,
              titulo,
              autor,
              editorial,
              lugar,
              paginas,
              anio,
              inventarioUnico: inventario,
              imagen: imagenData,
              fechaIngreso, // Añadido dentro del objeto que guarda cada ejemplar

            };

            const ref = db.collection('libros').doc(idPersonalizado);
            promesas.push(ref.set(ejemplar));
          }
          await Promise.all(promesas);
        } else {
          // Editar existentes
          const batch = db.batch();
          docsEjemplaresActuales.forEach((doc) => {
            const docRef = db.collection('libros').doc(doc.id);
            batch.update(docRef, {
              titulo,
              autor,
              editorial,
              lugar,
              paginas,
              anio,
              imagen: imagenData || doc.data().imagen,
            });
          });
          await batch.commit();
        }

        modal.style.display = 'none';
        location.reload();
      } catch (error) {
        console.error('Error guardando libro:', error);
        alert('Ocurrió un error al guardar el libro.');
      }
    }

    async function cargarLibros() {
      const snapshot = await db.collection('libros').orderBy('inventarioUnico', 'asc').get();

      const librosAgrupados = {};

      snapshot.forEach((doc) => {
        const data = doc.data();
        const key = data.titulo.trim().toLowerCase();
        if (!librosAgrupados[key]) {
          librosAgrupados[key] = {
            docs: [doc],
            titulo: data.titulo,
            autor: data.autor,
            editorial: data.editorial,
            lugar: data.lugar,
            paginas: data.paginas,
            anio: data.anio,
            imagen: data.imagen,
            cantidad: 1,
          };
        } else {
          librosAgrupados[key].cantidad++;
          librosAgrupados[key].docs.push(doc);
        }
      });

      const contenedor = document.querySelector('.contenedor-cuadros');
      contenedor.innerHTML = '';

      Object.values(librosAgrupados).forEach((libro) => {
        const nuevoCuadro = document.createElement('div');
        nuevoCuadro.classList.add('cuadro');

        nuevoCuadro.innerHTML = `
          <div>
            <h3>${libro.titulo}</h3>
            <p><strong>Autor:</strong> ${libro.autor}</p>
            <p><strong>Editorial:</strong> ${libro.editorial}</p>
            <p><strong>Lugar:</strong> ${libro.lugar}</p>
            <p><strong>Páginas:</strong> ${libro.paginas}</p>
            <p><strong>Año:</strong> ${libro.anio}</p>
            <p><strong>Fecha de ingreso:</strong> ${libro.docs[0].data().fechaIngreso || 'Sin registrar'}</p>

            <p><strong>Cantidad de ejemplares:</strong> ${libro.cantidad}</p>
            ${
              libro.imagen
                ? `<img src="${libro.imagen}" style="width:100px; height:100px; object-fit:cover;">`
                : ''
            }
            <button class="editar-btn">Editar</button>
          </div>
        `;

        const btnEditar = nuevoCuadro.querySelector('.editar-btn');
        btnEditar.addEventListener('click', () => abrirModalEdicion(libro));

        contenedor.appendChild(nuevoCuadro);
      });
    }

    function limpiarModal() {
      document.getElementById('titulo').value = '';
      document.getElementById('fechaIngreso').value = libro.docs[0].data().fechaIngreso || '';
      document.getElementById('autor').value = '';
      document.getElementById('editorial').value = '';
      document.getElementById('lugar').value = '';
      document.getElementById('paginas').value = '';
      document.getElementById('anio').value = '';
      document.getElementById('inventarioBase').value = '';
      document.getElementById('cantidadEjemplares').value = '';
      imagenInput.value = '';
      imagenPreview.src = '';
      imagenPreview.style.display = 'none';
      imagenData = '';
      document.getElementById('fechaIngresoTexto').textContent =
        `Fecha de ingreso: ${libro.docs[0].data().fechaIngreso || 'No registrada'}`;

      listaEjemplares.innerHTML = '';
      modoEdicion = false;
      docsEjemplaresActuales = [];
      tituloOriginal = '';
      document.getElementById('inventarioBase').disabled = false;
      document.getElementById('cantidadEjemplares').disabled = false;
    }

    function abrirModalEdicion(libro) {
      modoEdicion = true;
      limpiarModal();
      modal.style.display = 'block';
      modalTitulo.textContent = `Editar libro: ${libro.titulo}`;

      document.getElementById('titulo').value = libro.titulo;
      document.getElementById('autor').value = libro.autor;
      document.getElementById('editorial').value = libro.editorial;
      document.getElementById('lugar').value = libro.lugar;
      document.getElementById('paginas').value = libro.paginas;
      document.getElementById('anio').value = libro.anio;
      document.getElementById('inventarioBase').value = parseInt(libro.docs[0].data().inventarioUnico);
      document.getElementById('inventarioBase').disabled = false;
      document.getElementById('cantidadEjemplares').value = libro.cantidad;
      document.getElementById('cantidadEjemplares').disabled = false;

      imagenData = libro.imagen || '';
      if (imagenData) {
        imagenPreview.src = imagenData;
        imagenPreview.style.display = 'block';
      }

      docsEjemplaresActuales = libro.docs;
      tituloOriginal = libro.titulo;

      listaEjemplares.innerHTML = '';
      libro.docs.forEach((doc, index) => {
        const divEjemplar = document.createElement('div');
        divEjemplar.style.border = '1px solid #555';
        divEjemplar.style.margin = '5px 0';
        divEjemplar.style.padding = '5px';

        const numeroEjemplar = index + 1;
        const numeroInventario = doc.data().inventarioUnico;

        divEjemplar.textContent = `Ejemplar ${numeroEjemplar}: ${numeroInventario}`;
        listaEjemplares.appendChild(divEjemplar);
      });
    }

    // Generar rectángulos cuando cambian inventario base o cantidad
    document.getElementById('inventarioBase').addEventListener('input', generarRectangulosEjemplares);
    document.getElementById('cantidadEjemplares').addEventListener('input', generarRectangulosEjemplares);

    // Cargar libros al inicio
    window.addEventListener('load', cargarLibros);

    // Botón backup - descarga el backup JSON ordenado por inventarioUnico
    document.getElementById('btn-backup').addEventListener('click', async () => {
      const snapshot = await db.collection('libros').orderBy('inventarioUnico', 'asc').get();
      const libros = [];
      snapshot.forEach((doc) => {
        libros.push({ id: doc.id, ...doc.data() });
      });
      const backupJSON = JSON.stringify(libros, null, 2);
      const blob = new Blob([backupJSON], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'backup_biblioteca.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Botón importar backup
    const inputImportar = document.getElementById('input-importar');
    document.getElementById('btn-importar').addEventListener('click', () => {
      inputImportar.click();
    });
    inputImportar.addEventListener('change', async (event) => {
      const archivo = event.target.files[0];
      if (!archivo) return;

      const texto = await archivo.text();
      let datos;
      try {
        datos = JSON.parse(texto);
      } catch {
        alert('El archivo seleccionado no es un JSON válido.');
        return;
      }

      if (!Array.isArray(datos)) {
        alert('El JSON debe ser un array de libros.');
        return;
      }

      try {
        // Opcional: eliminar todos antes de importar (o preguntar)
        if (!confirm('Se eliminará el inventario actual antes de importar. ¿Querés continuar?')) {
          return;
        }
        const docs = await db.collection('libros').get();
        const batchBorrar = db.batch();
        docs.forEach((doc) => batchBorrar.delete(doc.ref));
        await batchBorrar.commit();

        const batchAgregar = db.batch();
        datos.forEach((libro) => {
          const ref = db.collection('libros').doc();
          batchAgregar.set(ref, libro);
        });
        await batchAgregar.commit();

        alert('Backup importado correctamente.');
        location.reload();
      } catch (error) {
        alert('Error al importar backup: ' + error.message);
      }
    });

    // Botón eliminar inventario completo
    document.getElementById('btn-borrar-todo').addEventListener('click', async () => {
      if (!confirm('¿Estás seguro que querés eliminar todo el inventario? Esta acción no se puede deshacer.')) return;
      try {
        const docs = await db.collection('libros').get();
        const batch = db.batch();
        docs.forEach((doc) => batch.delete(doc.ref));
        await batch.commit();
        alert('Inventario eliminado correctamente.');
        location.reload();
      } catch (error) {
        alert('Error eliminando inventario: ' + error.message);
      }
    });

    function normalizarTexto(texto) {
      return texto
        .toLowerCase()
        .normalize("NFD") // separa acentos
        .replace(/[\u0300-\u036f]/g, ""); // elimina diacríticos
    }

    function normalizarTexto(texto) {
      return texto
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, ""); // quita acentos
    }

    document.getElementById('barraInput').addEventListener('input', () => {
      const filtro = normalizarTexto(document.getElementById('barraInput').value.trim());
      const contenedor = document.querySelector('.contenedor-cuadros');
      const cuadros = Array.from(contenedor.getElementsByClassName('cuadro'));

      cuadros.forEach(cuadro => {
        const titulo = normalizarTexto(cuadro.querySelector('h3')?.textContent || '');
        cuadro.style.display = titulo.includes(filtro) || filtro === '' ? '' : 'none';
      });
    });




    const btnEliminar = document.getElementById('btnEliminar');

function abrirModalEdicion(libro) {
  modoEdicion = true;
  limpiarModal();
  modal.style.display = 'block';
  modalTitulo.textContent = `Editar libro: ${libro.titulo}`;

  // Carga datos en el modal
  document.getElementById('titulo').value = libro.titulo;
  document.getElementById('autor').value = libro.autor;
  document.getElementById('editorial').value = libro.editorial;
  document.getElementById('lugar').value = libro.lugar;
  document.getElementById('paginas').value = libro.paginas;
  document.getElementById('anio').value = libro.anio;
  document.getElementById('inventarioBase').value = parseInt(libro.docs[0].data().inventarioUnico);
  document.getElementById('inventarioBase').disabled = false;
  document.getElementById('cantidadEjemplares').value = libro.cantidad;
  document.getElementById('cantidadEjemplares').disabled = false;

  imagenData = libro.imagen || '';
  if (imagenData) {
    imagenPreview.src = imagenData;
    imagenPreview.style.display = 'block';
  }

  docsEjemplaresActuales = libro.docs;
  tituloOriginal = libro.titulo;

  listaEjemplares.innerHTML = '';
  libro.docs.forEach((doc, index) => {
    const divEjemplar = document.createElement('div');
    divEjemplar.style.border = '1px solid #555';
    divEjemplar.style.margin = '5px 0';
    divEjemplar.style.padding = '5px';

    const numeroEjemplar = index + 1;
    const numeroInventario = doc.data().inventarioUnico;

    divEjemplar.textContent = `Ejemplar ${numeroEjemplar}: ${numeroInventario}`;
    listaEjemplares.appendChild(divEjemplar);
  });

  // Mostrar botón eliminar
  btnEliminar.style.display = 'inline-block';
}

// Evento para eliminar libro
  btnEliminar.addEventListener('click', async () => {
    if (!confirm("¿Estás seguro de que querés eliminar este libro y todos sus ejemplares?")) return;

    try {
      const batch = db.batch();
      docsEjemplaresActuales.forEach(doc => {
        const docRef = db.collection("libros").doc(doc.id);
        batch.delete(docRef);
      });
      await batch.commit();

      alert("Libro eliminado con éxito.");
      modal.style.display = 'none';
      location.reload();

    } catch (error) {
      console.error("Error eliminando libro:", error);
      alert("Ocurrió un error al intentar eliminar el libro.");
    }
  });

  // Ocultar botón eliminar al limpiar modal
  function limpiarModal() {
    document.getElementById('titulo').value = '';
    document.getElementById('autor').value = '';
    document.getElementById('editorial').value = '';
    document.getElementById('lugar').value = '';
    document.getElementById('paginas').value = '';
    document.getElementById('anio').value = '';
    document.getElementById('inventarioBase').value = '';
    document.getElementById('cantidadEjemplares').value = '';
    imagenInput.value = '';
    imagenPreview.src = '';
    imagenPreview.style.display = 'none';
    imagenData = '';
    listaEjemplares.innerHTML = '';
    modoEdicion = false;
    docsEjemplaresActuales = [];
    tituloOriginal = '';
    document.getElementById('inventarioBase').disabled = false;
    document.getElementById('cantidadEjemplares').disabled = false;

    // Ocultar botón eliminar
    btnEliminar.style.display = 'none';
  }

  modal.addEventListener('click', (event) => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });

  </script>
</body>
</html>
